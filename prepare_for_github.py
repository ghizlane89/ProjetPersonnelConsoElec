#!/usr/bin/env python3
"""
üîÑ Script de pr√©paration du projet Energy-Agent pour GitHub
================================================================

Ce script pr√©pare le projet pour le partage sur GitHub en :
- Excluant les fichiers inutiles (cache, donn√©es sensibles, etc.)
- Cr√©ant une structure optimis√©e
- G√©n√©rant un fichier .gitignore appropri√©
- Cr√©ant un script d'installation automatique
"""

import os
import shutil
import zipfile
from pathlib import Path
import json

class GitHubPreparator:
    """Pr√©parateur de projet pour GitHub"""
    
    def __init__(self):
        self.project_root = Path.cwd()
        self.output_dir = self.project_root / "github_ready"
        self.excluded_patterns = [
            # Fichiers syst√®me
            ".DS_Store",
            "Thumbs.db",
            "*.swp",
            "*.swo",
            
            # Cache Python
            "__pycache__/",
            "*.pyc",
            "*.pyo",
            "*.pyd",
            ".pytest_cache/",
            ".mypy_cache/",
            
            # Environnements virtuels
            ".venv/",
            "venv/",
            "env/",
            
            # IDE
            ".vscode/",
            ".idea/",
            "*.sublime-*",
            
            # Donn√©es sensibles et volumineuses
            "*.duckdb",
            "*.db",
            ".env",
            "*.log",
            
            # Fichiers temporaires
            "*.tmp",
            "*.temp",
            "*.bak",
            
            # Build et distribution
            "build/",
            "dist/",
            "*.egg-info/",
            
            # Donn√©es de d√©veloppement
            "data_genere/processed/*.duckdb",
            "data_genere/backups/",
            "data_genere/raw/",
            
            # Fichiers de test temporaires
            "test_*.py",
            "debug_*.py",
            
            # Fichiers obsol√®tes
            "app_old.py",
            "app copy.py",
            "app2 copy.py",
        ]
        
        self.included_directories = [
            "orchestration/",
            "mcp_server/",
            "core/",
            "data_genere_gap/",
            "llm_planner/",
            "docs/",
        ]
        
        self.essential_files = [
            "app2.py",
            "environment.yml",
            "README.md",
            "LICENSE",
            ".gitignore",
        ]
    
    def clean_directory(self, directory):
        """Nettoie un r√©pertoire en supprimant les fichiers exclus"""
        for pattern in self.excluded_patterns:
            if pattern.endswith('/'):
                # R√©pertoire
                dir_pattern = directory / pattern.rstrip('/')
                if dir_pattern.exists():
                    print(f"üóëÔ∏è  Suppression du r√©pertoire: {dir_pattern}")
                    shutil.rmtree(dir_pattern, ignore_errors=True)
            else:
                # Fichier
                for file_path in directory.rglob(pattern):
                    if file_path.is_file():
                        print(f"üóëÔ∏è  Suppression du fichier: {file_path}")
                        file_path.unlink()
    
    def copy_essential_files(self):
        """Copie les fichiers essentiels"""
        print("üìÅ Copie des fichiers essentiels...")
        
        for file_name in self.essential_files:
            source = self.project_root / file_name
            if source.exists():
                dest = self.output_dir / file_name
                shutil.copy2(source, dest)
                print(f"‚úÖ Copi√©: {file_name}")
            else:
                print(f"‚ö†Ô∏è  Fichier non trouv√©: {file_name}")
    
    def copy_directories(self):
        """Copie les r√©pertoires inclus"""
        print("üìÅ Copie des r√©pertoires...")
        
        for dir_name in self.included_directories:
            source = self.project_root / dir_name
            if source.exists():
                dest = self.output_dir / dir_name
                shutil.copytree(source, dest, dirs_exist_ok=True)
                print(f"‚úÖ Copi√©: {dir_name}")
                
                # Nettoyer le r√©pertoire copi√©
                self.clean_directory(dest)
            else:
                print(f"‚ö†Ô∏è  R√©pertoire non trouv√©: {dir_name}")
    
    def create_sample_data(self):
        """Cr√©e un √©chantillon de donn√©es pour la d√©monstration"""
        print("üìä Cr√©ation d'√©chantillon de donn√©es...")
        
        sample_data_dir = self.output_dir / "data_genere" / "processed"
        sample_data_dir.mkdir(parents=True, exist_ok=True)
        
        # Cr√©er un fichier README pour les donn√©es
        data_readme = sample_data_dir / "README.md"
        data_readme.write_text("""
# üìä Donn√©es √ânerg√©tiques

Ce r√©pertoire contient les donn√©es de consommation √©lectrique.

## üöÄ Premi√®re Utilisation

1. **G√©n√©ration automatique** : L'application g√©n√©rera automatiquement les donn√©es au premier lancement
2. **Donn√©es fictives** : Les donn√©es sont g√©n√©r√©es de mani√®re r√©aliste pour la d√©monstration
3. **Base DuckDB** : Format optimis√© pour les requ√™tes analytiques

## üìã Structure des Donn√©es

- **P√©riode** : 2 ans de donn√©es fictives
- **Granularit√©** : Mesures toutes les 2 heures
- **√âquipements** : Cuisine, Buanderie, Ballon d'eau chaude
- **M√©triques** : Puissance, tension, consommation totale

## üîß G√©n√©ration

```bash
# L'application g√©n√®re automatiquement les donn√©es au premier lancement
streamlit run app2.py
```
""")
        
        print("‚úÖ √âchantillon de donn√©es cr√©√©")
    
    def create_installation_script(self):
        """Cr√©e un script d'installation automatique"""
        print("üîß Cr√©ation du script d'installation...")
        
        install_script = self.output_dir / "install.sh"
        install_script.write_text("""#!/bin/bash
# üöÄ Script d'installation Energy-Agent
# ======================================

echo "‚ö° Installation d'Energy Agent..."

# V√©rifier Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3 n'est pas install√©"
    exit 1
fi

# V√©rifier Conda
if ! command -v conda &> /dev/null; then
    echo "‚ùå Conda n'est pas install√©"
    echo "üì• Installez Conda depuis: https://docs.conda.io/en/latest/miniconda.html"
    exit 1
fi

# Cr√©er l'environnement
echo "üîß Cr√©ation de l'environnement conda..."
conda env create -f environment.yml

# Activer l'environnement
echo "‚úÖ Environnement cr√©√© avec succ√®s!"
echo ""
echo "üöÄ Pour lancer l'application:"
echo "   conda activate energy-agent"
echo "   streamlit run app2.py"
echo ""
echo "üìñ Consultez le README.md pour plus d'informations"
""")
        
        # Rendre le script ex√©cutable
        install_script.chmod(0o755)
        print("‚úÖ Script d'installation cr√©√©")
    
    def create_windows_install_script(self):
        """Cr√©e un script d'installation pour Windows"""
        print("üîß Cr√©ation du script d'installation Windows...")
        
        install_script = self.output_dir / "install.bat"
        install_script.write_text("""@echo off
REM üöÄ Script d'installation Energy-Agent (Windows)
REM ================================================

echo ‚ö° Installation d'Energy Agent...

REM V√©rifier Python
python --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Python n'est pas install√©
    echo üì• Installez Python depuis: https://python.org
    pause
    exit /b 1
)

REM V√©rifier Conda
conda --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Conda n'est pas install√©
    echo üì• Installez Conda depuis: https://docs.conda.io/en/latest/miniconda.html
    pause
    exit /b 1
)

REM Cr√©er l'environnement
echo üîß Cr√©ation de l'environnement conda...
conda env create -f environment.yml

REM Activer l'environnement
echo ‚úÖ Environnement cr√©√© avec succ√®s!
echo.
echo üöÄ Pour lancer l'application:
echo    conda activate energy-agent
echo    streamlit run app2.py
echo.
echo üìñ Consultez le README.md pour plus d'informations
pause
""")
        
        print("‚úÖ Script d'installation Windows cr√©√©")
    
    def create_github_gitignore(self):
        """Cr√©e un .gitignore optimis√© pour GitHub"""
        print("üìù Cr√©ation du .gitignore GitHub...")
        
        gitignore_content = """# Energy Agent - .gitignore pour GitHub
# ================================================

# Variables d'environnement
.env
.env.local
.env.*.local

# Donn√©es sensibles et volumineuses
*.duckdb
*.db
*.sqlite
*.sqlite3

# Cache Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Environnements virtuels
.env
.venv
env/
venv/
ENV/
env.bak/
venv.bak/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Logs
*.log
logs/

# Tests
.pytest_cache/
.coverage
htmlcov/

# Donn√©es de d√©veloppement
data_genere/processed/*.duckdb
data_genere/backups/
data_genere/raw/

# Fichiers temporaires
*.tmp
*.temp
*.bak

# Fichiers de test temporaires
test_*.py
debug_*.py

# Fichiers obsol√®tes
app_old.py
app copy.py
app2 copy.py
"""
        
        gitignore_file = self.output_dir / ".gitignore"
        gitignore_file.write_text(gitignore_content)
        print("‚úÖ .gitignore GitHub cr√©√©")
    
    def create_project_info(self):
        """Cr√©e un fichier d'informations sur le projet"""
        print("üìã Cr√©ation des informations projet...")
        
        project_info = {
            "name": "Energy Agent",
            "description": "Assistant Intelligent pour l'Analyse de Consommation √âlectrique",
            "version": "1.0.0",
            "author": "Votre Nom",
            "technologies": [
                "Python 3.11",
                "Streamlit",
                "LangGraph",
                "DuckDB",
                "Prophet",
                "Google Gemini"
            ],
            "features": [
                "Chat intelligent avec IA",
                "Tableau de bord interactif",
                "Pr√©visions Prophet",
                "Architecture agentique",
                "Interface moderne"
            ],
            "demo_video": "https://www.loom.com/share/bc94951d58f64ae1af4da87dba532ce6"
        }
        
        info_file = self.output_dir / "project_info.json"
        with open(info_file, 'w', encoding='utf-8') as f:
            json.dump(project_info, f, indent=2, ensure_ascii=False)
        
        print("‚úÖ Informations projet cr√©√©es")
    
    def create_zip_archive(self):
        """Cr√©e une archive ZIP du projet optimis√©"""
        print("üì¶ Cr√©ation de l'archive ZIP...")
        
        zip_path = self.project_root / "Energy-Agent-GitHub-Ready.zip"
        
        with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for root, dirs, files in os.walk(self.output_dir):
                for file in files:
                    file_path = Path(root) / file
                    arcname = file_path.relative_to(self.output_dir)
                    zipf.write(file_path, arcname)
        
        print(f"‚úÖ Archive cr√©√©e: {zip_path}")
        print(f"üìä Taille: {zip_path.stat().st_size / (1024*1024):.1f} MB")
    
    def prepare_project(self):
        """Pr√©pare le projet complet pour GitHub"""
        print("üöÄ Pr√©paration du projet Energy-Agent pour GitHub")
        print("=" * 60)
        
        # Nettoyer le r√©pertoire de sortie
        if self.output_dir.exists():
            shutil.rmtree(self.output_dir)
        self.output_dir.mkdir()
        
        # √âtapes de pr√©paration
        self.copy_essential_files()
        self.copy_directories()
        self.create_sample_data()
        self.create_installation_script()
        self.create_windows_install_script()
        self.create_github_gitignore()
        self.create_project_info()
        
        # Cr√©er l'archive ZIP
        self.create_zip_archive()
        
        print("\nüéâ Projet pr√©par√© avec succ√®s pour GitHub!")
        print("üìÅ Fichiers cr√©√©s:")
        print(f"   üì¶ Archive: Energy-Agent-GitHub-Ready.zip")
        print(f"   üìÅ Dossier: {self.output_dir}")
        print("\nüìã Prochaines √©tapes:")
        print("   1. D√©compressez l'archive sur GitHub")
        print("   2. V√©rifiez que tous les fichiers sont pr√©sents")
        print("   3. Testez l'installation avec install.sh/install.bat")
        print("   4. Lancez l'application avec streamlit run app2.py")

def main():
    """Fonction principale"""
    preparator = GitHubPreparator()
    preparator.prepare_project()

if __name__ == "__main__":
    main()
